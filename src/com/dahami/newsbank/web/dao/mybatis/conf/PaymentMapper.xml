<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="payment">


	<!--기간별 온라인/오프라인 결제 합계 -->
	<select id="selectTotalPrice" parameterType="java.util.HashMap"
		resultType="java.util.HashMap">
		SELECT CASE
		M.LGD_PAYTYPE WHEN 'SC9999' THEN 'offline' ELSE
		'onLine' END as TYPE,
		YEAR(M.LGD_PAYDATE) as Y, MONTH(M.LGD_PAYDATE)
		as M, SUM(D.price) AS
		totalPrice FROM `paymentManage`
		AS M LEFT JOIN
		`paymentDetail` D ON M.seq = D.`paymentManage_seq` LEFT JOIN `photo` P
		ON P.`uciCode` = D.`photo_uciCode`
		where
		M.LGD_RESPCODE='0000'
		AND 
		D.`status` = 2
		AND
		(P.`member_seq` = #{member_seq} OR P.`member_seq` IN (SELECT
		`adjSlave` FROM `adjustment` A
		INNER JOIN member M ON A.adjSlave = M.seq
		WHERE M.admission = 'Y' AND
		`adjMaster`=
		#{member_seq} ))
		AND M.LGD_PAYDATE BETWEEN #{start_date}
		AND
		#{end_date}
		GROUP BY TYPE,Y,M ORDER BY TYPE,Y,M ASC

	</select>

	<!--검색 기간별 온라인/오프라인 결제 내역 -->
	<select id="selectToTalAccountList" parameterType="java.util.HashMap"
		resultType="java.util.HashMap">

		SELECT M.`LGD_BUYER`,
		M.`LGD_BUYERID`, mm.compName AS LGD_BUYER_COMPNAME,
		M.`LGD_OID`,
		M.`LGD_PAYTYPE`,
		M.`LGD_PAYDATE`,
		D.`photo_uciCode`, D.`price`,
		U.`usage`,
		U.`division1`, U.`division2`,
		U.`division3`, U.`division4`,
		U.`usageDate`,
		mp.`compName` AS copyright,
		mp.`preRate`,
		mp.`postRate`
		FROM
		`paymentManage` AS M
		LEFT JOIN
		paymentDetail D ON M.seq =
		D.paymentManage_seq
		LEFT JOIN usageList U ON
		U.seq = D.usageList_seq
		LEFT JOIN photo P ON P.uciCode =
		D.photo_uciCode
		LEFT JOIN member mm ON
		M.member_seq = mm.seq
		LEFT JOIN
		member mp ON P.member_seq = mp.seq
		where
		D.`status` = 2
		AND
		(P.`member_seq` = #{member_seq} OR
		P.`member_seq` IN
		(SELECT `adjSlave`
		FROM `adjustment` A 
		INNER JOIN member M ON A.adjSlave = M.seq
		WHERE M.admission = 'Y' AND
		`adjMaster` =#{member_seq}))
		<if test="start_date !=null and end_date !=null">
		    <bind name="start_date" value="start_date + '000000'" />
		    <bind name="end_date" value="end_date + '235959'" />
		    
			AND M.LGD_PAYDATE BETWEEN #{start_date} AND
			#{end_date}
		</if>
		<if test="keyword !=null">
			<bind name="keyword" value="'%' + keyword + '%'" />
			AND (mm.`id` LIKE #{keyword} OR mm.`name` LIKE #{keyword}
			OR
			mm.`compName` LIKE #{keyword})
		</if>


		<if test="paytype !=null">
			AND M.`LGD_PAYTYPE`=#{paytype}
		</if>

		<if test="media !=null">
			AND P.`member_seq` IN (${media})
		</if>
		ORDER BY mp.`compName`, M.`LGD_PAYTYPE`,M.`LGD_PAYDATE` ASC
	</select>



	<!-- 결제 정보 목록 호출 -->
	<select id="selectPaymentManage"  parameterType="java.util.Map"
		resultType="com.dahami.newsbank.web.dto.PaymentManageDTO">
		SELECT `seq` as `paymentManage_seq`, `member_seq`, `LGD_BUYER`, `LGD_BUYERID`,
		`LGD_BUYERPHONE`, `LGD_RESPCODE`, `LGD_RESPMSG`, `LGD_OID`,
		`LGD_AMOUNT`, `LGD_TID`, `LGD_PAYTYPE`, `LGD_PAYDATE`, `LGD_PAYSTATUS`,
		`LGD_PRODUCTINFO`, `LGD_ACCOUNTNUM`, `regDate` FROM `paymentManage`
		where `member_seq` = #{member_seq}
		AND `LGD_PAYSTATUS` != '2'
		AND !(`LGD_PAYSTATUS`='3' AND now()  > date_add(`regDate`, interval 1 day))
		<!-- <if test="LGD_OID !=null">
			AND LGD_OID = #{LGD_OID}
		</if> -->
		ORDER BY regDate DESC 
		<if test="startPage !=null and pageVol != null">
		    LIMIT #{startPage}, #{pageVol}
	    </if>

	</select>
	
	<!-- 결제 정보 총 개수,금액 -->
	<select id="selectPaymentManageTotal"  parameterType="java.util.Map"
		resultType="java.util.HashMap">
		SELECT COUNT(seq) AS totalCount, COALESCE(SUM(`LGD_AMOUNT`), 0) as totalPrice
		FROM `paymentManage`
		where `member_seq` = #{member_seq}
		AND `LGD_PAYSTATUS` != '2'
		AND !(`LGD_PAYSTATUS`='3' AND now()  > date_add(`regDate`, interval 1 day))		
		ORDER BY regDate DESC 		
	</select>


	<!-- 결제 정보 상세 호출 -->
	<select id="selectPaymentDetail" resultMap="paymentManageResult">
		SELECT M.`seq` as `paymentManage_seq`,
		M.`member_seq`, M.`LGD_BUYER`,
		M.`LGD_BUYERID`,
		M.`LGD_BUYERPHONE`, M.`LGD_RESPCODE`,
		M.`LGD_RESPMSG`,
		M.`LGD_OID`,M.LGD_PAYSTATUS,
		M.`LGD_AMOUNT`, M.`LGD_TID`,
		M.`LGD_PAYTYPE`,
		M.`LGD_PAYDATE`,
		M.`LGD_PRODUCTINFO`, M.`LGD_FINANCENAME`,
		M.`LGD_ACCOUNTNUM`,
		M.`regDate`,
		D.`seq` as `paymentDetail_seq`,
		D.`usageList_seq`,
		D.`photo_uciCode`, D.`price`,
		D.`downStart`,
		D.`status`,
		D.`downEnd`, D.`downCount`,
		U.`seq` as `usageList_seq`,
		U.`usage`,
		U.`division1`, U.`division2`, U.`division3`, U.`division4`,
		U.`usageDate`, U.`price`,
		P.`uciCode`, P.`ownerType`, P.`saleStat` AS saleState,
		N.`compName` AS copyright,
		N.admission, N.withdraw, N.activate
		FROM
		`paymentManage`
		AS M
		LEFT JOIN
		paymentDetail D ON M.seq =
		D.paymentManage_seq
		LEFT JOIN
		usageList U ON
		U.seq = D.usageList_seq
		LEFT
		JOIN photo P ON P.uciCode =
		D.photo_uciCode
		LEFT JOIN member N
		ON P.member_seq = N.seq
		where
		M.`member_seq` =
		#{member_seq}
		<if test="LGD_OID !=null">
			AND M.LGD_OID = #{LGD_OID}
		</if>
		<if test="LGD_PAYSTATUS !=null">
			AND M.LGD_PAYSTATUS = #{LGD_PAYSTATUS}
		</if>

		ORDER BY M.`regDate` DESC
	</select>
	
	
	<!-- 결제 정보 호출 Result -->
	<resultMap id="paymentManageResult" type="com.dahami.newsbank.web.dto.PaymentManageDTO">
		<id property="paymentManage_seq" column="paymentManage_seq" />
		<result property="member_seq" column="member_seq" />
		<result property="LGD_BUYER" column="LGD_BUYER" />
		<result property="LGD_BUYERID" column="LGD_BUYERID" />
		<result property="LGD_BUYERPHONE" column="LGD_BUYERPHONE" />
		<result property="LGD_RESPCODE" column="LGD_RESPCODE" />
		<result property="LGD_PAYSTATUS" column="LGD_PAYSTATUS" />
		<result property="LGD_RESPMSG" column="LGD_RESPMSG" />
		<result property="LGD_OID" column="LGD_OID" />
		<result property="LGD_AMOUNT" column="LGD_AMOUNT" />
		<result property="LGD_TID" column="LGD_TID" />
		<result property="LGD_PAYTYPE" column="LGD_PAYTYPE" />
		<result property="LGD_PAYDATE" column="LGD_PAYDATE" />
		<result property="LGD_PRODUCTINFO" column="LGD_PRODUCTINFO" />
		<result property="LGD_FINANCENAME" column="LGD_FINANCENAME" />
		<result property="LGD_ACCOUNTNUM" column="LGD_ACCOUNTNUM" />
		<result property="regDate" column="regDate" />
		<association property="memberDTO" column="seq"
			javaType="com.dahami.newsbank.web.dto.MemberDTO" resultMap="memberResult" />
		<collection property="paymentDetailList"
			ofType="com.dahami.newsbank.web.dto.PaymentDetailDTO" resultMap="paymentDetailResult" />
	</resultMap>

	<!-- 결제 상세 정보 호출 Result -->
	<resultMap id="paymentDetailResult" type="com.dahami.newsbank.web.dto.PaymentDetailDTO">
		<id property="paymentDetail_seq" column="paymentDetail_seq" />
		<result property="paymentManage_seq" column="paymentManage_seq" />
		<result property="usageList_seq" column="usageList_seq" />
		<result property="photo_uciCode" column="photo_uciCode" />
		<result property="price" column="price" />
		<result property="status" column="status" />
		<result property="downStart" column="downStart" />
		<result property="downEnd" column="downEnd" />
		<result property="downCount" column="downCount" />
		<result property="regDate" column="regDate" />
		<result property="paystatus" column="LGD_PAYSTATUS" />
		<association property="usageDTO" column="usageList_seq"
			javaType="com.dahami.newsbank.web.dto.UsageDTO" resultMap="usageListResult" />
		<association property="photoDTO" column="photo_uciCode"
			javaType="com.dahami.newsbank.dto.PhotoDTO" resultMap="photoResult" />
		<association property="memberDTO" column="seq"
			javaType="com.dahami.newsbank.web.dto.MemberDTO" resultMap="memberResult" />
	</resultMap>

	<resultMap id="usageListResult" type="com.dahami.newsbank.web.dto.UsageDTO">
		<id property="usageList_seq" column="usageList_seq" />
		<result property="usage" column="usage" />
		<result property="division1" column="division1" />
		<result property="division2" column="division2" />
		<result property="division3" column="division3" />
		<result property="division4" column="division4" />
		<result property="usageDate" column="usageDate" />
		<result property="price" column="price" />

	</resultMap>


	<resultMap id="photoResult" type="com.dahami.newsbank.dto.PhotoDTO">
		<id property="uciCode" column="uciCode" />
		<result property="copyright" column="copyright" />
		<result property="ownerType" column="ownerType" />
		<result property="saleState" column="saleState" />
	</resultMap>
	
	
	<resultMap id="memberResult" type="com.dahami.newsbank.web.dto.MemberDTO">
		<id property="seq" column="seq" />
		<result property="type" column="type" />
		<result property="id" column="id" />
		<result property="name" column="name" />
		<result property="compName" column="compName" />
		<result property="email" column="email" />
		<result property="phone" column="phone" />
		<result property="admission" column="admission" />
		<result property="activate" column="activate" />
		<result property="withdraw" column="withdraw" />
	</resultMap>

	<!-- 결제정보 입력 -->
	<insert id="insertPaymentManage" parameterType="com.dahami.newsbank.web.dto.PaymentManageDTO"
		useGeneratedKeys="true" keyProperty="paymentManage_seq">
		INSERT INTO `paymentManage` (
		member_seq
		<if test="LGD_BUYER != null">, LGD_BUYER</if>
		<if test="LGD_BUYERID != null">,LGD_BUYERID</if>
		<if test="LGD_BUYERPHONE != null">, LGD_BUYERPHONE</if>
		<if test="LGD_RESPCODE != null">, LGD_RESPCODE</if>
		<if test="LGD_RESPMSG != null">, LGD_RESPMSG</if>
		<if test="LGD_OID != null">, LGD_OID</if>
		<if test="LGD_PAYSTATUS != null">, LGD_PAYSTATUS</if>
		<if test="LGD_AMOUNT >0">, LGD_AMOUNT</if>
		<if test="LGD_TID != null">, LGD_TID</if>
		<if test="LGD_PAYTYPE != null">, LGD_PAYTYPE</if>
		<if test="LGD_PAYDATE != null">, LGD_PAYDATE</if>
		<if test="LGD_PRODUCTINFO != null">, LGD_PRODUCTINFO</if>
		<if test="LGD_ACCOUNTNUM != null">, LGD_ACCOUNTNUM</if>
		) values (
		#{member_seq}
		<if test="LGD_BUYER != null">, #{LGD_BUYER}</if>
		<if test="LGD_BUYERID != null">, #{LGD_BUYERID}</if>
		<if test="LGD_BUYERPHONE != null">, #{LGD_BUYERPHONE}</if>
		<if test="LGD_RESPCODE != null">, #{LGD_RESPCODE}</if>
		<if test="LGD_RESPMSG != null">, #{LGD_RESPMSG}</if>
		<if test="LGD_OID != null">, #{LGD_OID}</if>
		<if test="LGD_PAYSTATUS != null">, #{LGD_PAYSTATUS}</if>
		<if test="LGD_AMOUNT>0">, #{LGD_AMOUNT}</if>
		<if test="LGD_TID != null">, #{LGD_TID}</if>
		<if test="LGD_PAYTYPE != null">, #{LGD_PAYTYPE}</if>
		<if test="LGD_PAYDATE != null">, #{LGD_PAYDATE}</if>
		<if test="LGD_PRODUCTINFO != null">, #{LGD_PRODUCTINFO}</if>
		<if test="LGD_ACCOUNTNUM != null">, #{LGD_ACCOUNTNUM}</if>
		)
		<selectKey resultType="int" keyProperty="paymentManage_seq">
			SELECT
			LAST_INSERT_ID()
		</selectKey>
	</insert>


	<!-- 결제 상세정보 입력 -->
	<insert id="insertPaymentDetail" parameterType="com.dahami.newsbank.web.dto.PaymentDetailDTO"
		useGeneratedKeys="true" keyProperty="paymentDetail_seq">
		INSERT INTO `paymentDetail` (
		paymentManage_seq
		<if test="usageList_seq != null">, usageList_seq</if>
		<if test="photo_uciCode != null">,photo_uciCode</if>
		<if test="price != null">, price</if>

		) values (
		#{paymentManage_seq}
		<if test="usageList_seq != null">, #{usageList_seq}</if>
		<if test="photo_uciCode != null">, #{photo_uciCode}</if>
		<if test="price != null">, #{price}</if>

		)
		<selectKey resultType="int" keyProperty="paymentDetail_seq">
			SELECT
			LAST_INSERT_ID()
		</selectKey>
	</insert>



	<!-- 결제 정보 업데이트 -->
	<update id="updatePaymentManage" parameterType="com.dahami.newsbank.web.dto.PaymentManageDTO">
		update `paymentManage`
		<set>
			LGD_RESPCODE = #{LGD_RESPCODE}
			<if test="LGD_RESPMSG != null">, LGD_RESPMSG = #{LGD_RESPMSG}</if>
			<if test="LGD_AMOUNT >0">, LGD_AMOUNT = #{LGD_AMOUNT}</if>
			<if test="LGD_PAYSTATUS==6 and LGD_AMOUNT ==0">, LGD_AMOUNT = #{LGD_AMOUNT}</if>
			<if test="LGD_PAYSTATUS==5 and LGD_AMOUNT ==0">, LGD_AMOUNT = #{LGD_AMOUNT}</if>
			<if test="LGD_TID != null">, LGD_TID = #{LGD_TID}</if>
			<if test="LGD_PAYSTATUS != null">, LGD_PAYSTATUS = #{LGD_PAYSTATUS}</if>
			<if test="LGD_FINANCENAME != null">, LGD_FINANCENAME = #{LGD_FINANCENAME}</if>
			<if test="LGD_RESPCODE != null">, LGD_RESPCODE = #{LGD_RESPCODE}</if>
			<if test="LGD_ACCOUNTNUM != null">, LGD_ACCOUNTNUM = #{LGD_ACCOUNTNUM}</if>

		</set>
		where LGD_OID = #{LGD_OID}
		<if test="member_seq != null and member_seq>0 ">AND member_seq = #{member_seq} </if>

	</update>
	
		<!-- 결제 정보 목록 호출 -->
	<select id="selectPaymentOID" parameterType="com.dahami.newsbank.web.dto.PaymentManageDTO"
		resultType="com.dahami.newsbank.web.dto.PaymentManageDTO">
		SELECT `seq` as `paymentManage_seq`, `member_seq`, `LGD_BUYER`, `LGD_BUYERID`,
		`LGD_BUYERPHONE`, `LGD_RESPCODE`, `LGD_RESPMSG`, `LGD_OID`,
		`LGD_AMOUNT`, `LGD_TID`, `LGD_PAYTYPE`, `LGD_PAYDATE`,`LGD_PAYSTATUS`,
		`LGD_PRODUCTINFO`, `LGD_ACCOUNTNUM`, `regDate` FROM `paymentManage`
		where  LGD_OID = #{LGD_OID}

	</select>
	

	<!-- 결제 상세 정보 업데이트 -->
	<update id="updatePaymentDetail" parameterType="com.dahami.newsbank.web.dto.PaymentDetailDTO">
		update `paymentDetail`
		<set>
		    regDate = NOW()
			<!-- <if test="downCount != null">, downCount = #{downCount}</if> -->
			<if test="price >0">, price = #{price}</if>
			<if test="downStart != null">, downStart = #{downStart}</if>
			<if test="downEnd != null">, downEnd = #{downEnd}</if>
			<if test="status != null">, status = #{status}</if>
		</set>
		where `seq`=#{paymentDetail_seq}
	</update>

	<!-- 결제상세사진 다운로드 수 증가 -->
	<update id="paymentDetailDownCount" parameterType="com.dahami.newsbank.web.dto.PaymentDetailDTO">
	    update `paymentDetail`
	    
	    <set>
	        downCount = downCount + 1
	    </set>
	    where `seq`=#{paymentDetail_seq}
    </update>
	
	<!-- 결제 이미지 날짜 갱신 -->
	<update id="updateDownloadDate" parameterType="com.dahami.newsbank.web.dto.PaymentDetailDTO">
		update `paymentDetail`
		<set>
			downStart = #{downStart} , downEnd = #{downEnd}
		</set>
		where paymentManage_seq = #{paymentManage_seq}

	</update>

	<delete id="deletePaymentCart">
		DELETE FROM basket WHERE
		member_seq=#{member_seq} AND photo_uciCode
		IN (SELECT photo_uciCode
		FROM paymentDetail WHERE
		paymentManage_seq =
		#{paymentManage_seq});
	</delete>
	
	<!-- 전체 사용자 구매내역 (오프라인 결제) -->
	<select id="selectAllPaymentDetail" parameterType="java.util.HashMap"
		resultType="java.util.HashMap">
		
	   SELECT D.`seq` AS paymentDetail_seq, M.`LGD_BUYER`,
		M.`LGD_OID`,
		M.`LGD_PAYTYPE`,
		M.`LGD_PAYDATE`,
		M.`LGD_PAYSTATUS`,
		M.`LGD_TID`,
		D.`photo_uciCode`, D.`price`, D.`status`, D.`usageList_seq`,
		U.`usage`,
		U.`division1`, U.`division2`,
		U.`division3`, U.`division4`,
		U.`usageDate`,
		P.`copyright`, P.`compCode`,
		mp.`preRate`,
		mp.`postRate`,
		mp.`compName`,
		mm.`name`,
		mm.`id`
		FROM
		`paymentManage` AS M
		LEFT JOIN
		paymentDetail D ON M.seq =
		D.paymentManage_seq
		LEFT JOIN usageList U ON
		U.seq = D.usageList_seq
		LEFT JOIN photo P ON P.uciCode =
		D.photo_uciCode
		LEFT JOIN member mm ON
		M.member_seq = mm.seq
		LEFT JOIN
		member mp ON P.member_seq = mp.seq
		where
		M.LGD_PAYSTATUS !='0' AND
		M.LGD_PAYTYPE = 'SC9999'	
		
		<if test="start_date !=null and end_date !=null">
			AND M.LGD_PAYDATE BETWEEN #{start_date} AND #{end_date}			
		</if>
		
		<if test="keyword !=null">
		    AND(
		    	<if test="keywordType == 'member'">
		    	    M.LGD_BUYER LIKE CONCAT('%', #{keyword}, '%')
					OR M.LGD_BUYERID LIKE CONCAT('%', #{keyword}, '%')
					OR mp.compName LIKE CONCAT('%', #{keyword}, '%')
		    	</if>
		    	
		    	<if test="keywordType == 'photo'">
		    	    P.uciCode LIKE CONCAT('%', #{keyword}, '%')
					OR P.compCode LIKE CONCAT('%', #{keyword}, '%')
		    	</if>
		    )
		</if>
		
		<if test="status !=null and status != 'all'">
			AND D.`status`= #{status}
		</if>
		
		ORDER BY M.`LGD_PAYDATE` DESC
		
		<if test="startPage !=null and pageVol != null">
		    LIMIT #{startPage}, #{pageVol}
	    </if>
		
	</select>
	
	<!-- 전체 사용자 구매내역 갯수 (오프라인 결제)-->
	<select id="AllPaymentDetailCnt" parameterType="java.util.HashMap"	resultType="integer">
		
	   SELECT COUNT(M.`seq`) as cnt
		FROM
		`paymentManage` AS M
		LEFT JOIN
		paymentDetail D ON M.seq =
		D.paymentManage_seq
		LEFT JOIN usageList U ON
		U.seq = D.usageList_seq
		LEFT JOIN photo P ON P.uciCode =
		D.photo_uciCode
		LEFT JOIN member mm ON
		M.member_seq = mm.seq
		LEFT JOIN
		member mp ON P.member_seq = mp.seq
		where
		M.LGD_PAYSTATUS !='0' AND 
		M.LGD_PAYTYPE = 'SC9999'		
		
		<if test="start_date !=null and end_date !=null">
			AND M.LGD_PAYDATE BETWEEN #{start_date} AND #{end_date}			
		</if>
		
		<if test="keyword !=null">
		    AND(
		    	<if test="keywordType == 'member'">
		    	    M.LGD_BUYER LIKE CONCAT('%', #{keyword}, '%')
					OR M.LGD_BUYERID LIKE CONCAT('%', #{keyword}, '%')
					OR mp.compName LIKE CONCAT('%', #{keyword}, '%')
		    	</if>
		    	
		    	<if test="keywordType == 'photo'">
		    	    P.uciCode LIKE CONCAT('%', #{keyword}, '%')
					OR P.compCode LIKE CONCAT('%', #{keyword}, '%')
		    	</if>
		    )
		</if>
		
		<if test="status !=null and status != 'all'">
			AND D.`status`= #{status}
		</if>
		
		ORDER BY M.`LGD_PAYDATE` DESC
	</select>
	
	<!-- 전체 사용자 구매내역 판매금액 함계 (오프라인 결제)-->
	<select id="AllPaymentDetailPrice" parameterType="java.util.HashMap"	resultType="integer">
		
	   SELECT COALESCE(SUM(D.`price`), 0) as sum
		FROM
		`paymentManage` AS M
		LEFT JOIN
		paymentDetail D ON M.seq =
		D.paymentManage_seq
		LEFT JOIN usageList U ON
		U.seq = D.usageList_seq
		LEFT JOIN photo P ON P.uciCode =
		D.photo_uciCode
		LEFT JOIN member mm ON
		M.member_seq = mm.seq
		LEFT JOIN
		member mp ON P.member_seq = mp.seq
		where
		M.LGD_PAYSTATUS !='0' AND 
		M.LGD_PAYTYPE = 'SC9999'	
		
		<if test="start_date !=null and end_date !=null">
			AND M.LGD_PAYDATE BETWEEN #{start_date} AND #{end_date}			
		</if>
		
		<if test="keyword !=null">
		    AND(
		    	<if test="keywordType == 'member'">
		    	    M.LGD_BUYER LIKE CONCAT('%', #{keyword}, '%')
					OR M.LGD_BUYERID LIKE CONCAT('%', #{keyword}, '%')
					OR mp.compName LIKE CONCAT('%', #{keyword}, '%')
		    	</if>
		    	
		    	<if test="keywordType == 'photo'">
		    	    P.uciCode LIKE CONCAT('%', #{keyword}, '%')
					OR P.compCode LIKE CONCAT('%', #{keyword}, '%')
		    	</if>
		    )
		</if>
		
		<if test="status !=null and status != 'all'">
			AND D.`status`= #{status}
		</if>
		
		ORDER BY M.`LGD_PAYDATE` DESC
	</select>
	
	<!-- 온라인 결제 (목록) -->
	<select id="onlinePayResult" parameterType="java.util.HashMap" 
	    resultType="com.dahami.newsbank.web.dto.PaymentManageDTO">
	    
	    SELECT PM.`seq` AS `paymentManage_seq`,
		    PM.`member_seq`,
			PM.`LGD_BUYER`,
			PM.`LGD_BUYERID`,
			PM.`LGD_PAYSTATUS`, 
			PM.`LGD_RESPMSG`,
			PM.`LGD_OID`,
			PM.`LGD_PAYDATE`,
			PM.`LGD_PAYTYPE`,
			PM.`LGD_AMOUNT`
		FROM paymentDetail PD 
		LEFT JOIN paymentManage PM ON PD.paymentManage_seq = PM.seq
		LEFT JOIN photo P ON PD.photo_uciCode = P.uciCode
		
		<where>
		    PM.LGD_PAYSTATUS !=0 AND <!-- 결제 실패를 제외하고 조회 -->
		    PM.LGD_PAYTYPE != 'SC9999' <!-- 온라인 결제만 조회 -->
		    <if test="keyword !=null and keyword != ''">
		        <if test="keywordType == 'member'"> <!-- 회사/기관명, 아이디, 이름 -->
		            <bind name="keyword" value="'%' + keyword + '%'" />
		            AND (
	            	 	PM.LGD_BUYERID LIKE #{keyword} OR
						PM.LGD_BUYER LIKE #{keyword}
		            )
	            </if>
	            
		        <if test="keywordType == 'photo'"> <!-- UCI코드, 언론사 사진번호 -->
		            <bind name="keyword" value="'%' + keyword + '%'" />
		            AND (
		            	P.compCode LIKE #{keyword} OR
		            	PD.photo_uciCode LIKE #{keyword}		            	
		            )
	            </if>
	        </if>
	        
		    <if test="LGD_PAYTYPE !=null and LGD_PAYTYPE != 'all'">
				AND PM.LGD_PAYTYPE = #{LGD_PAYTYPE}
			</if>
			
			<if test="LGD_PAYSTATUS !=null and LGD_PAYSTATUS != 'all'">
				AND PM.LGD_PAYSTATUS = #{LGD_PAYSTATUS}
			</if>
	        
	        <if test="start_date != null and end_date != null">
			    AND PM.LGD_PAYDATE BETWEEN #{start_date} AND #{end_date}
			</if>
		</where>
		GROUP BY PM.`seq`, PM.`member_seq`, PM.`LGD_BUYER`, PM.`LGD_BUYERID`, PM.`LGD_PAYSTATUS`, PM.`LGD_RESPMSG`, PM.`LGD_OID`, PM.`LGD_PAYDATE`, PM.`LGD_PAYTYPE`
		ORDER BY PM.`LGD_PAYDATE` DESC
		<if test="startPage !=null and pageVol != null">
		    LIMIT #{startPage}, #{pageVol}
	    </if>
    </select>
	
	<!-- 온라인 결제 (총 갯수) -->	
	<select id="onlinePayCount" parameterType="java.util.HashMap" 
	    resultType="integer">
		SELECT COUNT(DISTINCT(PM.`LGD_OID`)) as cnt
		FROM paymentDetail PD
		LEFT JOIN paymentManage PM ON PD.paymentManage_seq = PM.seq
		LEFT JOIN photo P ON PD.photo_uciCode = P.uciCode
		<where>
	        <!-- PM.LGD_PAYSTATUS = 1 AND --> <!-- 결제 승인건만 조회 -->
	        PM.LGD_PAYTYPE != 'SC9999' <!-- 온라인 결제만 조회 -->
		    <if test="keyword !=null and keyword != ''">
		        <if test="keywordType == 'member'"> <!-- 회사/기관명, 아이디, 이름 -->
		            <bind name="keyword" value="'%' + keyword + '%'" />
		            AND (
	            	 	PM.LGD_BUYERID LIKE #{keyword} OR
						PM.LGD_BUYER LIKE #{keyword}
		            )
	            </if>
	            
		        <if test="keywordType == 'photo'"> <!-- UCI코드, 언론사 사진번호 -->
		            <bind name="keyword" value="'%' + keyword + '%'" />
		            AND (
		            	P.compCode LIKE #{keyword} OR
		            	PD.photo_uciCode LIKE #{keyword}		            	
		            )
	            </if>
	        </if>
	        
		    <if test="LGD_PAYTYPE !=null and LGD_PAYTYPE != 'all'">
				AND PM.LGD_PAYTYPE = #{LGD_PAYTYPE}
			</if>
			
			<if test="LGD_PAYSTATUS !=null and LGD_PAYSTATUS != 'all'">
				AND PM.LGD_PAYSTATUS = #{LGD_PAYSTATUS}
			</if>
	        
	        <if test="start_date != null and end_date != null">
			    AND PM.LGD_PAYDATE BETWEEN #{start_date} AND #{end_date}
			</if>
		</where>
		ORDER BY paymentManage_seq DESC
	</select>
	
	<!-- 온라인 결제 (총 합계 금액) -->
	<select id="onlinePayPrice" parameterType="java.util.HashMap" 
	    resultType="integer">
		SELECT COALESCE(SUM(PD.`price`), 0) as sum			
		FROM paymentDetail PD
		LEFT JOIN paymentManage PM ON PD.paymentManage_seq = PM.seq AND PD.status = 0
		LEFT JOIN photo P ON PD.photo_uciCode = P.uciCode
		<where>
	        <!-- PM.LGD_PAYSTATUS = 1 AND --> <!-- 결제 승인건만 조회 -->
	        PM.LGD_PAYTYPE != 'SC9999' <!-- 온라인 결제만 조회 -->
		    <if test="keyword !=null and keyword != ''">
		        <if test="keywordType == 'member'"> <!-- 회사/기관명, 아이디, 이름 -->
		            <bind name="keyword" value="'%' + keyword + '%'" />
		            AND (
	            	 	PM.LGD_BUYERID LIKE #{keyword} OR
						PM.LGD_BUYER LIKE #{keyword}
		            )
	            </if>
	            
		        <if test="keywordType == 'photo'"> <!-- UCI코드, 언론사 사진번호 -->
		            <bind name="keyword" value="'%' + keyword + '%'" />
		            AND (
		            	P.compCode LIKE #{keyword} OR
		            	PD.photo_uciCode LIKE #{keyword}		            	
		            )
	            </if>
	        </if>
	        
		    <if test="LGD_PAYTYPE !=null and LGD_PAYTYPE != 'all'">
				AND PM.LGD_PAYTYPE = #{LGD_PAYTYPE}
			</if>
			
			<if test="LGD_PAYSTATUS !=null and LGD_PAYSTATUS != 'all'">
				AND PM.LGD_PAYSTATUS = #{LGD_PAYSTATUS}
			</if>
	        
	        <if test="start_date != null and end_date != null">
			    AND PM.LGD_PAYDATE BETWEEN #{start_date} AND #{end_date}
			</if>
		</where>
		ORDER BY paymentManage_seq DESC
	</select>
	
	
	<!-- 결제 정보 상세리스트 호출 -->
	<select id="selectWherePaymentDetail" resultMap="paymentManageResult">
		SELECT M.`seq` as `paymentManage_seq`,
		M.`member_seq`, M.`LGD_BUYER`,
		M.`LGD_BUYERID`,
		M.`LGD_BUYERPHONE`, M.`LGD_RESPCODE`,
		M.`LGD_RESPMSG`,
		M.`LGD_OID`,M.LGD_PAYSTATUS,
		M.`LGD_AMOUNT`, M.`LGD_TID`,
		M.`LGD_PAYTYPE`,
		M.`LGD_PAYDATE`,
		M.`LGD_PRODUCTINFO`, M.`LGD_FINANCENAME`,
		M.`LGD_ACCOUNTNUM`,
		M.`regDate`,
		D.`seq` as `paymentDetail_seq`,
		D.`usageList_seq`,
		D.`photo_uciCode`, D.`price`,
		D.`downStart`,
		D.`status`,
		D.`downEnd`, D.`downCount`,
		R.`compName`, R.`id`, R.`name`,
		R.`email`, R.`phone`, R.`type`,
		U.`seq` as `usageList_seq`,
		U.`usage`,
		U.`division1`, U.`division2`, U.`division3`, U.`division4`,
		U.`usageDate`, U.`price`,
		P.`uciCode`, P.`ownerType`, P.`compCode`, 
		media.compName AS copyright
		FROM
		`paymentManage`
		AS M
		LEFT JOIN
		paymentDetail D ON M.seq =
		D.paymentManage_seq
		INNER JOIN
		member R ON M.member_seq =
		R.seq
		LEFT JOIN
		usageList U ON
		U.seq = D.usageList_seq
		LEFT
		JOIN photo P ON P.uciCode =
		D.photo_uciCode
		INNER JOIN member media ON 
		P.member_seq = media.seq
		<where>		  
		    <if test="member_seq != null and member_seq != 0">
		        M.`member_seq` =
				#{member_seq}
		    </if>  
			<if test="LGD_OID !=null">
				AND M.LGD_OID = #{LGD_OID}
			</if>
			<if test="LGD_PAYSTATUS !=null">
				AND M.LGD_PAYSTATUS = #{LGD_PAYSTATUS}
			</if>
			<!-- <if test="paymentDetailList != null">
			    AND D.`seq` = #{paymentDetailList.get(0).}
			</if> -->
		</where>
		ORDER BY M.`regDate` DESC
	</select>
	
	
	<!-- 구매내역 리스트 호출 -->
	<select id="selectPaymentDetailList" resultMap="paymentDetailResult" parameterType="java.util.Map">
		SELECT M.`seq` as `paymentManage_seq`,
		M.`member_seq`, M.`LGD_BUYER`,
		M.`LGD_BUYERID`,
		M.`LGD_BUYERPHONE`, M.`LGD_RESPCODE`,
		M.`LGD_RESPMSG`,
		M.`LGD_OID`,M.LGD_PAYSTATUS,
		M.`LGD_AMOUNT`, M.`LGD_TID`,
		M.`LGD_PAYTYPE`,
		M.`LGD_PAYDATE`,
		M.`LGD_PRODUCTINFO`, M.`LGD_FINANCENAME`,
		M.`LGD_ACCOUNTNUM`,
		M.`regDate`,
		D.`seq` as `paymentDetail_seq`,
		D.`usageList_seq`,
		D.`status`,
		D.`photo_uciCode`, D.`price`,
		D.`downStart`,
		D.`downEnd`, D.`downCount`,
		R.`compName`, R.`id`, R.`name`,
		R.`email`, R.`phone`,
		U.`seq` as `usageList_seq`,
		U.`usage`,
		U.`division1`, U.`division2`, U.`division3`, U.`division4`,
		U.`usageDate`, U.`price`,
		P.`uciCode`, P.`ownerType`, P.`saleStat` AS saleState,
		N.compName AS copyright,
		N.admission, N.withdraw, N.activate
		FROM
		`paymentManage`
		AS M
		LEFT JOIN
		paymentDetail D ON M.seq =
		D.paymentManage_seq
		INNER JOIN
		member R ON M.member_seq =
		R.seq
		LEFT JOIN
		usageList U ON
		U.seq = D.usageList_seq
		LEFT
		JOIN photo P ON P.uciCode =
		D.photo_uciCode
		INNER JOIN member N
		ON P.member_seq = N.seq
		<where>		  
		    <foreach item="member_seq" collection="memberList" index="idx" open="(" separator="OR" close=")">
	            M.member_seq = #{member_seq} 
	        </foreach> 			
		    <if test="year != 0 and year != null">
				AND YEAR(M.regDate) = #{year}
			</if>
			<if test="month != 0 and month != null">
			    AND MONTH(M.regDate) = #{month}
		    </if>
		</where>
		ORDER BY M.`regDate` DESC
		LIMIT #{startPage}, #{pageVol}
	</select>
	
	<!-- 구매내역 총 개수/금액 -->
	<select id="selectPaymentDetailListTotal" resultType="java.util.HashMap" parameterType="java.util.Map">
		SELECT COUNT(M.`seq`) AS totalCount, COALESCE(SUM(M.`LGD_AMOUNT`), 0) as totalPrice
		FROM
		`paymentManage`
		AS M
		LEFT JOIN
		paymentDetail D ON M.seq =
		D.paymentManage_seq
		INNER JOIN
		member R ON M.member_seq =
		R.seq
		LEFT JOIN
		usageList U ON
		U.seq = D.usageList_seq
		LEFT
		JOIN photo P ON P.uciCode =
		D.photo_uciCode
		INNER JOIN member N
		ON P.member_seq = N.seq
		<where>		  
		    <foreach item="member_seq" collection="memberList" index="idx" open="(" separator="OR" close=")">
	            M.member_seq = #{member_seq} 
	        </foreach> 			
		    <if test="year != 0 and year != null">
				AND YEAR(M.regDate) = #{year}
			</if>
			<if test="month != 0 and month != null">
			    AND MONTH(M.regDate) = #{month}
		    </if>
		</where>
		ORDER BY M.`regDate` DESC
	</select>
	
	<!-- 결제 상세내역 취소 -->
	<!-- <update id="cancelPaymentDetail" parameterType="com.dahami.newsbank.web.dto.PaymentDetailDTO"> -->
    <update id="updatePaymentDetailStatus" parameterType="com.dahami.newsbank.web.dto.PaymentDetailDTO">
		update `paymentDetail`
		<set>
			<if test="status != null">status = #{status}</if>
		</set>
		where paymentManage_seq = #{paymentManage_seq}
		<if test="paymentDetail_seq !=null and paymentDetail_seq > 0">
				AND seq = #{paymentDetail_seq}
			</if>

	</update>
	   
    <!-- 결제정보 입력 -->
    <insert id="insPaymentManageDev" parameterType="java.util.Map">
		INSERT INTO paymentManage
			(member_seq, 
			LGD_BUYER,
			LGD_BUYERID,
			LGD_BUYERPHONE,
			LGD_RESPCODE,
			LGD_RESPMSG,
			LGD_OID,
			LGD_AMOUNT,
			LGD_TID,
			LGD_PAYSTATUS,
			LGD_PAYDATE,
			LGD_PAYTYPE,
			LGD_PRODUCTINFO,
			LGD_FINANCENAME,
			LGD_ACCOUNTNUM,
			regDate)
		VALUES
			(#{member_seq},
			#{LGD_BUYER},
			#{LGD_BUYERID},
			#{LGD_BUYERPHONE},
			#{LGD_RESPCODE},
			#{LGD_RESPMSG},
			#{LGD_OID},
			#{LGD_AMOUNT},
			#{LGD_TID},
			1,
			#{LGD_PAYDATE},
			#{LGD_PAYTYPE},
			#{LGD_PRODUCTINFO},
			#{LGD_FINANCENAME},
			#{LGD_ACCOUNTNUM},
			#{regDate})
	</insert>
	
    <!-- 결제정보 조회 -->
    <select id="selManageSeq" resultType="int">
		SELECT seq
		FROM paymentManage
		WHERE LGD_OID = #{LGD_OID} AND LGD_TID = #{LGD_TID};
	</select>
	
    <!-- 결제상세정보 입력 -->
    <insert id="insPaymentDetailDev" parameterType="java.util.Map">
		INSERT INTO paymentDetail
			(paymentManage_seq, 
			usageList_seq,
			photo_uciCode,
			price,
			downStart,
			downEnd,
			downCount,
			status,
			regDate)
		VALUES
			(#{paymentManage_seq},
			#{usageList_seq},
			'${photo_uciCode}',
			#{price},
			#{downStart},
			#{downEnd},
			1,
			2,
			#{regDate})
	</insert>
	
    <!-- 오프라인 결제 정보 -->
    <select id="selectOfflinePay" parameterType="com.dahami.newsbank.web.dto.PaymentDetailDTO" 
	    resultType="com.dahami.newsbank.web.dto.PaymentManageDTO">
	    
	    SELECT PM.`seq` AS paymentManage_seq,
		    PM.`member_seq`,
			PM.`LGD_BUYER`,
			PM.`LGD_BUYERID`,
			PM.`LGD_PAYSTATUS`, 
			PM.`LGD_RESPMSG`,
			PM.`LGD_OID`,
			PM.`LGD_PAYDATE`,
			PM.`LGD_PAYTYPE`,
			PM.`LGD_AMOUNT`
		FROM paymentDetail PD 
		LEFT JOIN paymentManage PM ON PD.paymentManage_seq = PM.seq
		<where>		    
		    PM.LGD_PAYTYPE = 'SC9999' <!-- 오프라인 결제만 조회 -->
		    AND PD.seq = #{paymentDetail_seq}
		</where>
	</select>
	
    <!-- 미승인 오프라인 결제내역 갯수  -->
    <select id="selectUnArrovePaymentDeatilCnt" parameterType="com.dahami.newsbank.web.dto.PaymentDetailDTO"
         resultType="integer">		
        
		SELECT COUNT(seq) as cnt
		FROM paymentDetail
		WHERE paymentManage_seq = #{paymentManage_seq} AND status != 2 
		
	</select>
</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="calculation">
   	<!-- 정산승인 -->
   	<insert id="insertCalculation" parameterType="com.dahami.newsbank.web.dto.CalculationDTO" 
   	    useGeneratedKeys="true" keyProperty="seq">
   	    INSERT INTO `calculations` (
   	    <if test="id != null">`id`</if>
   	    <if test="uciCode != null">, `uciCode`</if>
   	    <if test="usage != null">, `usage`</if>
   	    <if test="type != null">, `type`</if>
   	    <if test="payType != null">, `payType`</if>
   	    <if test="price != null">, `price`</if>
   	    <if test="fees != null">, `fees`</if>
   	    <if test="rate >0">, `rate`</if>
   	    <if test="status != null">, `status`</if>
   	    <if test="regDate != null">, `regDate`</if>   	     
		) VALUES (
		<if test="id != null">#{id}</if>
		<if test="uciCode != null">, #{uciCode}</if>
		<if test="usage != null">, #{usage}</if>
		<if test="type != null">, #{type}</if>
		<if test="payType != null">, #{payType}</if>
		<if test="price != null">, #{price}</if>
		<if test="fees != null">, #{fees}</if>
		<if test="rate >0">, #{rate}</if>
		<if test="status != null">, #{status}</if>
		<if test="regDate != null">, #{regDate}</if>
		)
		
		<selectKey resultType="int" keyProperty="seq">
			SELECT
			LAST_INSERT_ID()
		</selectKey>
   	</insert>
   	
   	<!-- 정산/피정산 상세내역 Result -->
   	<resultMap id="calculationResult" type="com.dahami.newsbank.web.dto.CalculationDTO">
		<id property="seq" column="seq" />
		<result property="id" column="id" />
		<result property="name" column="name" />
		<result property="compName" column="compName" />
		<result property="copyright" column="copyright" />
		<result property="member_seq" column="member_seq" />
		<result property="payType" column="payType" />
		<result property="uciCode" column="uciCode" />
		<result property="usage" column="usage" />
		<result property="type" column="type" />
		<result property="price" column="price" />
		<result property="status" column="status" />
		<result property="fees" column="fees" />
		<result property="rate" column="rate" />
		<result property="regDate" column="regDate" />
		
		<association property="memberDTO" column="seq"
			javaType="com.dahami.newsbank.web.dto.MemberDTO" resultMap="memberResult" />
		<association property="usageDTO" column="usage"
			javaType="com.dahami.newsbank.web.dto.UsageDTO" resultMap="usageResult" />
	</resultMap>
	
   	<resultMap id="memberResult" type="com.dahami.newsbank.web.dto.MemberDTO">
		<id property="seq" column="seq" />
		<result property="type" column="type" />
		<result property="id" column="id" />
		<result property="admission" column="admission" />
		<result property="withdraw" column="withdraw" />
		<result property="activate" column="activate" />
		<result property="compName" column="compName" />
	</resultMap>
	
   	<resultMap id="usageResult" type="com.dahami.newsbank.web.dto.UsageDTO">
 	    <id property="usageList_seq" column="usageList_seq" />
		<result property="usage" column="usageName" />
		<result property="division1" column="division1" />
		<result property="division2" column="division2" />
		<result property="division3" column="division3" />
		<result property="division4" column="division4" />
		<result property="usageDate" column="usageDate" />
		<result property="price" column="price" />
 	</resultMap>
   	
   	<!-- 정산매체, 피정산매체 선택에 따른 정산결과 -->
   	<!-- <select id="selectCalculation" resultType="com.dahami.newsbank.web.dto.CalculationDTO" 
   	    parameterType="com.dahami.newsbank.web.dto.CalculationDTO"> -->
	<select id="selectCalculation" resultMap="calculationResult" 
   	    parameterType="com.dahami.newsbank.web.dto.CalculationDTO"> 
   	   SELECT C.seq, C.id, M.name, M.compName, SM.name as copyright, P.member_seq, C.`payType`,  
   	   C.`uciCode`, C.`usage`, C.`type`, C.`price`, C.`status`, C.`fees`, C.`rate`, C.`regDate`,
   	   U.`usage` AS usageName, U.division1, U.division2, U.division3, U.division4, U.price,
   	   SM.seq, SM.`type`, SM.id, SM.admission, SM.withdraw, SM.activate, SM.compName
		FROM calculations C
		INNER JOIN member M ON C.id = M.id
		INNER JOIN usageList U ON C.`usage` =  U.seq
		INNER JOIN photo P ON C.uciCode = P.uciCode
		INNER JOIN member SM ON P.member_seq = SM.seq
		
		<where>
		    <if test="member_seqArr != null and member_seqArr.length != 0">
		        <foreach item="slaveSeq" collection="member_seqArr" index="idx" open="(" separator="OR" close=")">
		            P.member_seq = #{slaveSeq} 
		        </foreach>
		    </if>
		    <if test="payType != null and payType != 'all'">
		    	AND C.`payType` = #{payType}    
		    </if>		    
		    <if test="start_date != null and end_date != null">
		    	AND date_format(C.`regDate`, '%Y-%m-%d') BETWEEN #{start_date} AND #{end_date}     
		    </if>
		    <if test="keyword != null and keyword != ''">
		    	<if test="keywordType == 'member2'"> <!-- 회사/기관명, 아이디, 이름 -->
				 AND M.id LIKE CONCAT('%', #{keyword}, '%')
				     OR M.name LIKE CONCAT('%', #{keyword}, '%')
				     OR M.compName LIKE CONCAT('%', #{keyword}, '%')
				</if>
				<if test="keywordType == 'photo'"> <!-- UCI코드, 언론사 사진번호 -->
				 AND P.uciCode LIKE CONCAT('%', #{keyword}, '%')
				    OR (SELECT compCode FROM photo WHERE uciCode = C.uciCode) LIKE CONCAT('%', #{keyword}, '%')
				</if>
	            <bind name="keyword" value="'%' + keyword + '%'" />
	            AND (M.`name` LIKE #{keyword} OR M.`compName` LIKE #{keyword} OR M.`id` LIKE #{keyword})
            </if>
	    </where>
		
   	</select>
   	
   	<!-- 월별 정산통계 Result -->
	<resultMap id="calculationMonthResult" type="java.util.HashMap">
		<result javaType="java.lang.String" column="YearOfMonth" property="YearOfMonth"></result>
		<result javaType="java.lang.Integer" column="price" property="price"></result>
		<result javaType="java.lang.Integer" column="type" property="type"></result>
		<result javaType="java.lang.Integer" column="count" property="count"></result>
	</resultMap>
   	
   	<!-- 정산/피정산 전체매체를 대상으로 온/오프라인 월별 통계 -->
   	<select id="selectOfMonth" resultMap="calculationMonthResult">
   	    SELECT DATE_FORMAT(c.regDate, '%Y-%m') AS YearOfMonth, SUM(price) AS price, c.`type`, COUNT(price) AS count
		FROM calculations c
		INNER JOIN photo p ON c.uciCode = p.uciCode
		INNER JOIN member m on c.id = m.id
		<where>
		    <if test="member_seqArr != null and member_seqArr.length != 0">
		        <foreach item="slaveSeq" collection="member_seqArr" index="idx" open="(" separator="OR" close=")">
		            p.member_seq = #{slaveSeq} 
		        </foreach>
		    </if>
		    <if test="start_date != null and end_date != null">
		        AND DATE_FORMAT(c.regDate, '%Y-%m-%d') BETWEEN #{start_date} AND #{end_date}
	        </if>		    
	        <if test="payType != null and payType != 'all'">
	            AND c.payType = #{payType}
	        </if>
	        <if test="keyword != null and keyword != ''">
		        <if test="keywordType == 'member'"> <!-- 회사/기관명, 아이디, 이름 -->
				 AND (
				 	 m.id LIKE CONCAT('%', #{keyword}, '%')
			    	 OR m.name LIKE CONCAT('%', #{keyword}, '%')
				     OR m.compName LIKE CONCAT('%', #{keyword}, '%')
				    )
				</if>
				<if test="keywordType == 'photo'"> <!-- UCI코드, 언론사 사진번호 -->
				 AND(
				 	 p.uciCode LIKE CONCAT('%', #{keyword}, '%')
				    OR (SELECT compCode FROM photo WHERE uciCode = c.uciCode) LIKE CONCAT('%', #{keyword}, '%')
				    )
				</if>
	        </if>
		</where>
		GROUP BY DATE_FORMAT(c.regDate, '%Y-%m'), `type`
		ORDER BY DATE_FORMAT(c.regDate, '%Y-%m')
   	</select>
</mapper>
    
<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Member">

	<!-- 활성 매체사 리스트 읽기 -->
	<select id="listActiveMedia" resultType="com.dahami.newsbank.web.dto.MemberDTO">
		select * from member
		where type = 'M'
		and activate = 1
		order by name asc
	</select>

	<select id="selMamberBySeq" parameterType="integer" resultType="com.dahami.newsbank.web.dto.MemberDTO">
		select * from member
			where seq = #{seq}
	</select>

	<!-- 로그인 체크 및 비밀번호 찾기 -->
	<select id="selectLogin" parameterType="com.dahami.newsbank.web.dto.MemberDTO"
		resultType="com.dahami.newsbank.web.dto.MemberDTO">
		SELECT
		`seq`, `id`, `pw`, `email`, `name`, `phone`, `type`,
		`permission`,
		`deferred`, `compNum`, `compDocPath`, `compName`,
		`compAddress`,
		`compAddDetail`, `compZipcode`, `compBankName`,
		`compBankAcc`,
		`compBankPath`, `compTel`, `contractPath`,
		DATE_FORMAT(`contractStart`,'%Y-%m-%d') AS `contractStart`,
		DATE_FORMAT(`contractEnd`,'%Y-%m-%d') AS `contractEnd`,
		`contractAuto`, `preRate`, `postRate`,
		`taxName`,
		`taxPhone`,
		`taxEmail`, DATE_FORMAT(`regDate`,'%Y-%m-%d') AS
		`regDate`,
		`logo`,
		`activate`, `master_seq`, `group_seq` FROM member
		where
		1
		<if test="id != null">
			AND id = #{id}
		</if>
		<if test="pw != null">
			AND pw = #{pw}
		</if>
		<if test="name != null">
			AND name = #{name}
		</if>
		<if test="phone != null">
			AND phone = #{phone}
		</if>
		<if test="seq >0">
			AND seq = #{seq}
		</if>

	</select>

	<!-- 회원가입 아이디 체크 -->
	<select id="selectId" parameterType="java.util.Map" resultType="int">
		SELECT count(seq) FROM member
		where id = #{id}


	</select>

	<!-- 회원가입 -->
	<insert id="insertMember" parameterType="com.dahami.newsbank.web.dto.MemberDTO"
		useGeneratedKeys="true" keyProperty="seq">
		INSERT INTO member (
		id, pw, email ,name, phone, type
		<if test="compNum != null">, compNum</if>
		<if test="compDocPath != null">, compDocPath</if>
		<if test="compName != null">, compName</if>
		<if test="compAddress != null">, compAddress</if>
		<if test="compAddDetail != null">, compAddDetail</if>
		<if test="compZipcode != null">, compZipcode</if>
		<if test="compTel != null">, compTel</if>
		<if test="logo != null">, logo</if>
		) values (
		#{id},#{pw},#{email},#{name},#{phone},#{type}
		<if test="compNum != null">, #{compNum}</if>
		<if test="compDocPath != null">, #{compDocPath}</if>
		<if test="compName != null">, #{compName}</if>
		<if test="compAddress != null">, #{compAddress}</if>
		<if test="compAddDetail != null">, #{compAddDetail}</if>
		<if test="compZipcode != null">, #{compZipcode}</if>
		<if test="compTel != null">, #{compTel}</if>
		<if test="logo != null">, #{logo}</if>
		)
		<selectKey resultType="int" keyProperty="seq">
			SELECT
			LAST_INSERT_ID()
		</selectKey>

	</insert>

	<!-- 회원정보 업데이트 -->
	<update id="updateMember" parameterType="com.dahami.newsbank.web.dto.MemberDTO">
		update member
		<set>
			type = #{type}
			<if test="pw != null">, pw = #{pw}</if>
			<if test="email != null">, email = #{email}</if>
			<if test="name != null">, name = #{name}</if>
			<if test="phone != null">, phone = #{phone}</if>
			<if test="permission != null">, permission = #{permission}</if>
			<if test="deferred != null">, deferred = #{deferred}</if>
			<if test="compNum != null">, compNum = #{compNum}</if>
			<if test="compDocPath != null">, compDocPath = #{compDocPath}</if>
			<if test="compName != null">, compName = #{compName}</if>
			<if test="compAddress != null">, compAddress = #{compAddress}</if>
			<if test="compAddDetail != null">, compAddDetail = #{compAddDetail}</if>
			<if test="compZipcode != null">, compZipcode = #{compZipcode}</if>
			<if test="compBankName != null">, compBankName = #{compBankName}</if>
			<if test="compBankAcc != null">, compBankAcc = #{compBankAcc}</if>
			<if test="compBankPath != null">, compBankPath = #{compBankPath}</if>
			<if test="compTel != null">, compTel = #{compTel}</if>
			<if test="contractPath != null">, contractPath = #{contractPath}</if>
			<if test="contractStart != null">, contractStart = #{contractStart}</if>
			<if test="contractEnd != null">, contractEnd = #{contractEnd}</if>
			<if test="contractAuto != null">, contractAuto = #{contractAuto}</if>
			<if test="preRate != null">, preRate = #{preRate}</if>
			<if test="postRate != null">, postRate = #{postRate}</if>
			<if test="taxName != null">, taxName = #{taxName}</if>
			<if test="taxPhone != null">, taxPhone = #{taxPhone}</if>
			<if test="taxEmail != null">, taxEmail = #{taxEmail}</if>
			<if test="logo != null">, logo = #{logo}</if>
			<if test="activate >0">, activate = #{activate}</if>
			<if test="master_seq >0">, master_seq = #{master_seq}</if>
			<if test="group_seq >0">, group_seq = #{group_seq}</if>
		</set>
		where seq = #{seq}
	</update>


	<!-- 아이디 찾기 -->
	<select id="selectFindId" parameterType="com.dahami.newsbank.web.dto.MemberDTO"
		resultType="com.dahami.newsbank.web.dto.MemberDTO">
		SELECT * FROM member
		WHERE name = #{name}
		AND phone= #{phone}
	</select>

	<!-- 활성 매체사 리스트 읽기 -->
	<select id="listAdjustMedia" resultType="com.dahami.newsbank.web.dto.MemberDTO">
		SELECT
		`seq`, `id`, `email`, `name`, `phone`, `type`,
		`permission`,
		`deferred`, `compNum`, `compDocPath`, `compName`,
		`compAddress`,
		`compAddDetail`, `compZipcode`, `compBankName`,
		`compBankAcc`,
		`compBankPath`, `compTel`, `contractPath`,
		DATE_FORMAT(`contractStart`,'%Y-%m-%d') AS `contractStart`,
		DATE_FORMAT(`contractEnd`,'%Y-%m-%d') AS `contractEnd`,
		`contractAuto`, `preRate`, `postRate`,
		`taxName`,
		`taxPhone`, `taxEmail`, DATE_FORMAT(`regDate`,'%Y-%m-%d') AS
		`regDate`,
		`logo`, `activate`, `master_seq`, `group_seq` FROM `member`
		WHERE `type` = 'M'
		AND `activate` = 1
		AND `compName`!=''
		AND `compName`
		is not null
		<if test="seq != 0">
			AND `seq` = #{seq}
			OR `seq` IN (SELECT `adjSlave` FROM
			`adjustment` WHERE `admission`='Y'
			AND `adjMaster` = #{seq})
		</if>
		ORDER BY `compName` ASC
	</select>


	<select id="selGetty" resultType="com.dahami.newsbank.web.dto.MemberDTO">
		select * from member where id = 'gettyimage';
	</select>
	
	<!-- 관리자 회원현황 목록 -->
	<select id="selMemberList" resultType="com.dahami.newsbank.web.dto.MemberDTO" parameterType="java.util.Map">
	    SELECT A.*, B.groupName FROM member A 
	    LEFT JOIN `group` B ON A.group_seq = B.seq
	    <where>
	        
            <if test="keyword != null"> <!-- 키워드 -->
	            ( `id` LIKE CONCAT('%',#{keyword},'%') OR `name` LIKE CONCAT('%',#{keyword},'%') OR `compName` LIKE CONCAT('%',#{keyword},'%') )
            </if>
            	        
	        <if test="type != ''"> <!-- 회원구분 -->
	            AND `type` = #{type}
            </if>
            
			<if test="deferred != ''"> <!-- 결제구분 -->
				AND `deferred` = #{deferred}    
			</if>
			
			<if test='group == "I"'> <!-- 개별 -->
				AND `group_seq` is NULL    
			</if>
			
			<if test='group == "G"'> <!-- 그룹 -->
				AND `group_seq` is not NULL    
			</if>
			
		</where>
		ORDER BY A.regDate DESC 
		LIMIT #{startPage}, #{pageVol}
	</select>
	
	<!-- 정산 매체사 MediaDTO -->
	<resultMap id="MediaDTO" type="java.util.HashMap">
	    <!-- <result javaType="java.lang.Integer" column="blind" property="blind"></result>
	    <result javaType="java.lang.Integer" column="total" property="total"></result> -->
	    <result javaType="java.lang.Integer" column="seq" property="seq"></result>
	    <result javaType="java.lang.String" column="id" property="id"></result>
	    <result javaType="java.lang.String" column="email" property="email"></result>
	    <result javaType="java.lang.String" column="name" property="name"></result>
	    <result javaType="java.lang.String" column="phone" property="phone"></result>
	    <result javaType="java.lang.String" column="compNum" property="compNum"></result>
	    <result javaType="java.lang.String" column="compName" property="compName"></result>
	    <result javaType="java.lang.String" column="preRate" property="preRate"></result>
	    <result javaType="java.lang.String" column="postRate" property="postRate"></result>
	    <result javaType="java.lang.String" column="masterID" property="masterID"></result>
	</resultMap>
	
	<!-- 관리자 정산 매체사 목록 -->	
	<select id="selMediaList" resultMap="MediaDTO" parameterType="java.util.Map">
	    SELECT (SELECT id FROM member WHERE seq = adjustment.adjMaster) AS masterID, member.seq, id, email, name, phone, compNum, compName, preRate, postRate 
	    FROM member 
		LEFT JOIN adjustment ON member.seq = adjustment.adjSlave
		WHERE member.type='M'		
	        
        <if test="keyword != null"> 
         AND ( `id` LIKE CONCAT('%',#{keyword},'%') OR `name` LIKE CONCAT('%',#{keyword},'%') OR `compName` LIKE CONCAT('%',#{keyword},'%') )
        </if>
			
		ORDER BY member.regDate DESC 
		LIMIT #{startPage}, #{pageVol}
	</select>
	
	<!-- 콘텐츠 수량 DTO (블라인드 / 전체 갯수) -->
	<resultMap id="ContentDTO" type="java.util.HashMap">
	    <result javaType="java.lang.Integer" column="blind" property="blind"></result>
	    <result javaType="java.lang.Integer" column="total" property="total"></result>
    </resultMap>
    
	<!-- 블라인드 & 전체 콘텐츠 갯수 -->
	<select id="countContents" resultMap="ContentDTO" parameterType="java.util.Map">
	    SELECT SUM(IF(saleStat=2, 1, 0)) AS blindCnt, COUNT(uciCode) AS totalCnt
		FROM photo A
		LEFT JOIN member B ON A.member_seq = B.seq
		WHERE B.type='M' AND B.seq = #{seq}
	</select>
	
	<!-- 정산 매체사 MediaDTO -->
	<!-- <resultMap id="MediaDTO" type="java.util.HashMap">
	    <result javaType="java.lang.Integer" column="blind" property="blind"></result>
	    <result javaType="java.lang.Integer" column="total" property="total"></result>
	    <result javaType="java.lang.Integer" column="seq" property="seq"></result>
	    <result javaType="java.lang.String" column="id" property="id"></result>
	    <result javaType="java.lang.String" column="email" property="email"></result>
	    <result javaType="java.lang.String" column="name" property="name"></result>
	    <result javaType="java.lang.String" column="phone" property="phone"></result>
	    <result javaType="java.lang.String" column="compNum" property="compNum"></result>
	    <result javaType="java.lang.String" column="compName" property="compName"></result>
	    <result javaType="java.lang.String" column="preRate" property="preRate"></result>
	    <result javaType="java.lang.String" column="postRate" property="postRate"></result>
	</resultMap> -->
	
	<!-- 관리자 정산 매체사 목록 -->	
	<!-- <select id="selMediaList" resultMap="MediaDTO" parameterType="java.util.Map">
	    SELECT SUM(IF(saleStat=2, 1, 0)) AS blind, COUNT(uciCode) AS total, 
		seq, id, email, name, phone, compNum, compName, preRate, postRate
		FROM news_bank_dev.photo
		LEFT JOIN member ON photo.member_seq = member.seq
		WHERE member.type='M'
		
		<if test="keyword != null">  
         	AND ( `id` LIKE CONCAT('%',#{keyword},'%') OR `name` LIKE CONCAT('%',#{keyword},'%') OR `compName` LIKE CONCAT('%',#{keyword},'%') )
        </if>
        
		GROUP BY member_seq
		ORDER BY member.regDate DESC
	</select> -->
	
	<!-- 회원현황(그룹추가) -->
	<insert id="insertGroup" useGeneratedKeys="true" keyProperty="seq">	    
	    <selectKey resultType="integer" keyProperty="seq" order="AFTER">
			SELECT
			LAST_INSERT_ID()
		</selectKey>
		INSERT INTO `group` (groupName, regDate) VALUES (#{groupName}, NOW())
	</insert>
	
	<!-- 회원현황 (선택회원 그룹정보 변경) -->
	<update id="updateMemberGroup">
	    UPDATE member SET group_seq = #{group_seq} WHERE 
	    <foreach collection="id" item="mID"  separator="OR">
	        ( id = #{mID} )
	    </foreach>
	</update>
	
	<!-- 조건에 따른 전체 회원명수 -->
	<select id="memberCnt" resultType="integer" parameterType="java.util.Map">	    
	    SELECT count(seq) as cnt 
	    FROM member 
	    <where>
	        
            <if test="keyword != null and keyword != ''"> <!-- 키워드 -->
	            ( `id` LIKE CONCAT('%',#{keyword},'%') OR `name` LIKE CONCAT('%',#{keyword},'%') OR `compName` LIKE CONCAT('%',#{keyword},'%') )
            </if>
            	        
	        <if test="type != ''"> <!-- 회원구분 -->
	            AND `type` = #{type}
            </if>
            
			<if test="deferred != ''"> <!-- 결제구분 -->
				AND `deferred` = #{deferred}    
			</if>
			
			<if test='group == "I"'> <!-- 개별 -->
				AND `group_seq` is NULL    
			</if>
			
			<if test='group == "G"'> <!-- 그룹 -->
				AND `group_seq` is not NULL    
			</if>
			
		</where>
	    ORDER BY regDate DESC
	</select>
	
	<!-- 조건에 따른 전체 정산매체수 -->
	<select id="mediaCnt" resultType="integer" parameterType="java.util.Map">	    
	    SELECT count(seq) as cnt 
	    FROM member 
	    WHERE `type` = 'M'
	        
        <if test="keyword != null and keyword != ''"> <!-- 키워드 -->
         AND ( `id` LIKE CONCAT('%',#{keyword},'%') OR `name` LIKE CONCAT('%',#{keyword},'%') OR `compName` LIKE CONCAT('%',#{keyword},'%') )
        </if>
            
	    ORDER BY regDate DESC
	</select>
</mapper>
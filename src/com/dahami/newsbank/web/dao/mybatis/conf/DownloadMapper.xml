<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Download">
	<insert id="insDownload" keyColumn="seq" keyProperty="seq" useGeneratedKeys="true" parameterType="com.dahami.newsbank.web.dto.DownloadDTO">
		insert 
			into download
			(photo_uciCode, member_seq, ipAddress)
			values
       		(#{uciCode}, #{memberSeq}, #{ipAddress})
    </insert>
	
	<select id="selDownloadable" parameterType="java.util.Map" resultType="int">
		<![CDATA[
		SELECT seq 
			FROM 
				paymentDetail
			WHERE photo_uciCode = #{uciCode}
				AND downStart <= NOW() 
				AND downEnd >= NOW() 
				AND paymentManage_seq IN 
					(SELECT seq FROM paymentManage WHERE member_seq IN (${memberListStr}) AND LGD_PAYSTATUS = 1)
		]]>
	</select>
	
	<!-- 정산 매체사 MediaDTO -->
	<resultMap id="DelayDownloadDTO" type="java.util.HashMap">
	    <result javaType="java.lang.Integer" column="seq" property="seq"></result>
	    <result javaType="java.lang.String" column="photo_uciCode" property="photo_uciCode"></result>
	    <result javaType="java.lang.String" column="ipAddress" property="ipAddress"></result>
	    <result javaType="java.lang.String" column="regDate" property="regDate"></result>
	    <result javaType="java.lang.String" column="copyright" property="copyright"></result>
	</resultMap>
	
	<select id="selDownList" parameterType="java.util.Map" resultMap="DelayDownloadDTO">
	    SELECT A.seq, A.photo_uciCode, A.ipAddress, A.regDate, B.copyright
			FROM `download` A
		INNER JOIN photo B
		ON A.photo_uciCode = B.uciCode
		WHERE A.member_seq = #{member_seq}
		<if test="year != 0">
			AND YEAR(A.regDate) = #{year}
		</if>
		ORDER BY A.regDate DESC
		LIMIT #{startPage}, #{pageVol}
	</select>
	
	<select id="selDownListTotalCnt" parameterType="java.util.Map" resultType="integer">
	    SELECT COUNT(A.seq) as cnt
			FROM `download` A
		INNER JOIN photo B
		ON A.photo_uciCode = B.uciCode
		WHERE A.member_seq = #{member_seq}
		<if test="year != 0">
			AND YEAR(A.regDate) = #{year}
		</if>
		ORDER BY A.regDate DESC
	</select>
	
	<!-- 전체 사용자 다운로드 내역 -->
	<resultMap id="TotalDownloadDTO" type="java.util.HashMap">
	    <result javaType="java.lang.String" column="id" property="id"></result>
	    <result javaType="java.lang.String" column="name" property="name"></result>
	    <result javaType="java.lang.String" column="compName" property="compName"></result>
	    <result javaType="java.lang.String" column="media" property="media"></result>
	    <result javaType="java.lang.String" column="uciCode" property="uciCode"></result>
	    <result javaType="java.lang.String" column="compCode" property="compCode"></result>
	    <result javaType="java.lang.String" column="regDate" property="regDate"></result>
	</resultMap>
	
	<!-- 전체 다운로드 내역  -->
	<select id="TotalDownlist" parameterType="java.util.Map" resultMap="TotalDownloadDTO">
	    SELECT M.compName, M.id, M.name,
		(SELECT name FROM member WHERE seq = P.member_seq) AS media, 
		P.uciCode, P.compCode, D.regDate  FROM download D
		INNER JOIN member M ON D.member_seq = M.seq
		INNER JOIN photo P ON D.photo_uciCode = P.uciCode
		
		WHERE (
			<if test="keywordType == 'member'"> <!-- 회사/기관명, 아이디, 이름 -->
			     M.id LIKE CONCAT('%', #{keyword}, '%')
				 OR M.name LIKE CONCAT('%', #{keyword}, '%')
				 OR M.compName LIKE CONCAT('%', #{keyword}, '%')
			</if>
			
			<if test="keywordType == 'photo'"> <!-- UCI코드, 언론사 사진번호 -->
			    P.uciCode LIKE CONCAT('%', #{keyword}, '%')
				OR (SELECT compCode FROM photo WHERE uciCode = D.photo_uciCode) LIKE CONCAT('%', #{keyword}, '%')
			</if>
		)
		ORDER BY D.regDate DESC
		LIMIT #{startPage}, #{pageVol}
    </select>
    
	<!-- 전체 다운로드 내역 갯수 -->
	<select id="totalCnt" parameterType="java.util.Map" resultType="integer">
	    SELECT COUNT(D.seq) AS cnt
	    FROM download D
		INNER JOIN member M ON D.member_seq = M.seq
		INNER JOIN photo P ON D.photo_uciCode = P.uciCode
		
		WHERE (
			<if test="keywordType == 'member'"> <!-- 회사/기관명, 아이디, 이름 -->
			     M.id LIKE CONCAT('%', #{keyword}, '%')
				 OR M.name LIKE CONCAT('%', #{keyword}, '%')
				 OR M.compName LIKE CONCAT('%', #{keyword}, '%')
			</if>
			
			<if test="keywordType == 'photo'"> <!-- UCI코드, 언론사 사진번호 -->
			    P.uciCode LIKE CONCAT('%', #{keyword}, '%')
				OR (SELECT compCode FROM photo WHERE uciCode = D.photo_uciCode) LIKE CONCAT('%', #{keyword}, '%')
			</if>
		)
		ORDER BY D.regDate DESC 
    </select>
	
	<!-- 비구매 계정 -->
	<resultMap id="userMap" type="java.util.HashMap">
	    <result javaType="java.lang.String" column="compName" property="compName"></result>
	    <result javaType="java.lang.String" column="id" property="id"></result>
	    <result javaType="java.lang.String" column="name" property="name"></result>
	    <result javaType="java.lang.String" column="phone" property="phone"></result>
	</resultMap>
	
	<select id="notSellList" parameterType="java.util.Map" resultMap="userMap">
	    SELECT m.compName, m.name, m.id, m.seq, m.phone FROM download down
		INNER JOIN member m ON down.member_seq = m.seq
		WHERE m.deferred = 2
		AND m.seq NOT IN (SELECT member_seq FROM paymentManage)
		<if test="keyword !=null">
			<bind name="keyword" value="'%' + keyword + '%'" />
			AND (m.compName LIKE #{keyword} OR m.name LIKE #{keyword} OR m.id LIKE #{keyword}) 
		</if>
		ORDER BY down.regDate DESC
		LIMIT #{startPage}, #{pageVol}
	</select>
	
	<select id="notSellListCount" parameterType="java.util.Map" resultType="integer">
	    SELECT COUNT(m.seq) as cnt FROM download down
		INNER JOIN member m ON down.member_seq = m.seq
		WHERE m.deferred = 2
		AND m.seq NOT IN (SELECT member_seq FROM paymentManage)
		<if test="keyword !=null">
			<bind name="keyword" value="'%' + keyword + '%'" />
			AND (m.compName LIKE #{keyword} OR m.name LIKE #{keyword} OR m.id LIKE #{keyword}) 
		</if>
		ORDER BY down.regDate DESC		
	</select>
</mapper>
    
<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Member">

	<!--
	활성 매체사 리스트 읽기 (검색대상 매체)
	- 승인 못 받은 경우(admission = N) 불러오지 않음
	- 탈퇴 회원(withdraw = 1) 불러오지 않음
	- 계정 비활성화(activate = 2) 불러오지 않음
	-->
	<select id="listActiveMedia" resultType="com.dahami.newsbank.web.dto.MemberDTO">
		select * from member
		where type IN ('M','F')
		and activate != 2
		and withdraw != 1
		and admission != 'N'
		order by name asc
	</select>
	
	<!-- 
	현재 회원인 승인받은 매체사 리스트 읽기 (관리자 CMS 매체)
	- 승인 못 받은 경우(admission = N) 불러오지 않음
	- 탈퇴 회원(withdraw = 1) 불러오지 않음
	 -->
	<select id="listManagableMedia" resultType="com.dahami.newsbank.web.dto.MemberDTO">
		select * from member
		where type IN ('M','F')
		and withdraw != 1
		and admission != 'N'
		order by name asc
	</select>

	<select id="selMamberBySeq" parameterType="integer" resultType="com.dahami.newsbank.web.dto.MemberDTO">
		select * from member
			where seq = #{seq}
	</select>

	<!-- 
	하위매체 리스트를 읽어온다 
	- 승인 못 받은 경우(admission = N) 불러오지 않음
	- 탈퇴 회원(withdraw = 1) 불러오지 않음
	-->
	<select id="listSlaveAdj" parameterType="int" resultType="int">
		select adjSlave from member A, adjustment B 
		where A.seq = B.adjSlave 
			and type IN ('M','F')
			and withdraw != 1
			and admission != 'N' 
			and adjMaster = #{value}
	</select>
	
	<!-- 
	정산관리 하위 매체 리스트를 읽어온다
	 -->
	<select id="listSlaveRep" parameterType="int" resultType="int">
		select repSlave from member A, repPayment B
			where A.seq = repSlave
				and withdraw != 1
				and repMaster = #{value}
	</select>
	
	<!-- 
	그룹매체 리스트를 읽어온다
	 -->
	<select id="listGroupMember" parameterType="int" resultType="int">
		select seq from member 
			where group_seq = #{value}
				and withdraw != 1
	</select>

	<!-- 로그인 체크 및 비밀번호 찾기 -->
	<select id="selectLogin" parameterType="com.dahami.newsbank.web.dto.MemberDTO"
		resultType="com.dahami.newsbank.web.dto.MemberDTO">
		SELECT
		`seq`, `id`, `pw`,`pwCurrent`,`pwPast`, `email`, `name`, `phone`, `type`,
		`permission`,
		`deferred`, `compNum`, `compDocPath`, `compName`,
		`compAddress`,
		`compAddDetail`, `compZipcode`, `compBankName`,
		`compBankAcc`,
		`compBankPath`, `compTel`, `compExtTel`, `contractPath`,
		DATE_FORMAT(`contractStart`,'%Y-%m-%d') AS `contractStart`,
		DATE_FORMAT(`contractEnd`,'%Y-%m-%d') AS `contractEnd`,
		`contractAuto`, `preRate`, `postRate`,
		`taxName`,
		`taxPhone`,
		`taxEmail`, `taxExtTell`, DATE_FORMAT(`regDate`,'%Y-%m-%d') AS
		`regDate`,
		`logo`,
		`activate`, `withdraw`, `group_seq`, `admission` FROM member
		where
		1
		<if test="id != null">
			AND id = BINARY(#{id}) 
		</if>
		<if test="pw != null">
			AND (pw = #{pw} OR pw = #{pwCurrent} OR pw = #{pwPast})
		</if>
		<if test="name != null">
			AND name = #{name}
		</if>
		<if test="phone != null">
			AND phone = #{phone}
		</if>
		<if test="seq >0">
			AND seq = #{seq}
		</if>

	</select>

	<!-- 회원가입 아이디 체크 -->
	<select id="selectId" parameterType="java.util.Map" resultType="int">
		SELECT count(seq) FROM member
		where id = BINARY(#{id}) 


	</select>

	<!-- 회원가입 -->
	<insert id="insertMember" parameterType="com.dahami.newsbank.web.dto.MemberDTO"
		useGeneratedKeys="true" keyProperty="seq">
		INSERT INTO member (
		id, pw, email ,name, phone, type
		<if test="compNum != null">, compNum</if>
		<if test="compDocPath != null">, compDocPath</if>
		<if test="compName != null">, compName</if>
		<if test="compAddress != null">, compAddress</if>
		<if test="compAddDetail != null">, compAddDetail</if>
		<if test="compZipcode != null">, compZipcode</if>
		<if test="compTel != null">, compTel</if>
		<if test="compExtTel != null">, compExtTel</if>
		<if test="logo != null">, logo</if>
		
		<if test="compBankName != null">, compBankName</if>
		<if test="compBankAcc != null">, compBankAcc</if>
		<if test="deferred != null">, deferred</if>
		<if test="contractStart != null">, contractStart</if>
		<if test="contractEnd != null">, contractEnd</if>
		<if test="preRate != null">, preRate</if>
		<if test="postRate != null">, postRate</if>
		<if test="taxName != null">, taxName</if>
		<if test="taxPhone != null">, taxPhone</if>
		<if test="taxExtTell != null">, taxExtTell</if>
		<if test="taxEmail != null">, taxEmail</if>
		<if test="activate != null">, activate</if>
		) values (
		#{id},#{pw},#{email},#{name},#{phone},#{type}
		<if test="compNum != null">, #{compNum}</if>
		<if test="compDocPath != null">, #{compDocPath}</if>
		<if test="compName != null">, #{compName}</if>
		<if test="compAddress != null">, #{compAddress}</if>
		<if test="compAddDetail != null">, #{compAddDetail}</if>
		<if test="compZipcode != null">, #{compZipcode}</if>
		<if test="compTel != null">, #{compTel}</if>
		<if test="compExtTel != null">, #{compExtTel}</if>
		<if test="logo != null">, #{logo}</if>
		
		<if test="compBankName != null">, #{compBankName}</if>
		<if test="compBankAcc != null">, #{compBankAcc}</if>
		<if test="deferred != null">, #{deferred}</if>
		<if test="contractStart != null">, #{contractStart}</if>
		<if test="contractEnd != null">, #{contractEnd}</if>
		<if test="preRate != null">, #{preRate}</if>
		<if test="postRate != null">, #{postRate}</if>
		<if test="taxName != null">, #{taxName}</if>
		<if test="taxPhone != null">, #{taxPhone}</if>
		<if test="taxExtTell != null">, #{taxExtTell}</if>
		<if test="taxEmail != null">, #{taxEmail}</if>
		<if test="activate != null">, #{activate}</if>
		)
		<selectKey resultType="int" keyProperty="seq">
			SELECT
			LAST_INSERT_ID()
		</selectKey>

	</insert>

	<!-- 회원정보 업데이트 -->
	<update id="updateMember" parameterType="com.dahami.newsbank.web.dto.MemberDTO">
		update member
		<set>
			type = #{type} 
			<if test="id != null">, id = #{id}</if>
			<if test="pw != null">, pw = #{pw}</if>
			<if test="email != null">, email = #{email}</if>
			<if test="name != null">, name = #{name}</if>
			<if test="phone != null">, phone = #{phone}</if>
			<if test="permission != null">, permission = #{permission}</if>
			<if test="deferred >0">, deferred = #{deferred}</if>
			<if test="compNum != null">, compNum = #{compNum}</if>
			<if test="compDocPath != null">, compDocPath = #{compDocPath}</if>
			<if test="compName != null and !compName.equals('')">, compName = #{compName}</if>
			<if test="compAddress != null">, compAddress = #{compAddress}</if>
			<if test="compAddDetail != null">, compAddDetail = #{compAddDetail}</if>
			<if test="compZipcode != null">, compZipcode = #{compZipcode}</if>
			<if test="compBankName != null">, compBankName = #{compBankName}</if>
			<if test="compBankAcc != null">, compBankAcc = #{compBankAcc}</if>
			<if test="compBankPath != null">, compBankPath = #{compBankPath}</if>
			<if test="compTel != null">, compTel = #{compTel}</if>
			<if test="compExtTel != null">, compExtTel = #{compExtTel}</if>
			<if test="contractPath != null">, contractPath = #{contractPath}</if>
			<if test="contractStart != null">, contractStart = #{contractStart}</if>
			<if test="contractEnd != null">, contractEnd = #{contractEnd}</if>
			<if test="contractAuto != null">, contractAuto = #{contractAuto}</if>
			<if test="preRate != null">, preRate = #{preRate}</if>
			<if test="postRate != null">, postRate = #{postRate}</if>
			<if test="taxName != null">, taxName = #{taxName}</if>
			<if test="taxPhone != null">, taxPhone = #{taxPhone}</if>
			<if test="taxEmail != null">, taxEmail = #{taxEmail}</if>
			<if test="taxExtTell != null">, taxExtTell = #{taxExtTell}</if>
			<if test="logo != null">, logo = #{logo}</if>
			<if test="activate >0">, activate = #{activate}</if>
			<if test="admission != null">, admission = #{admission}</if>
			<if test="group_seq >0">, group_seq = #{group_seq}</if>
			<if test="loginDate != null">, loginDate = #{loginDate}</if>
		</set>
		where seq = #{seq}
	</update>

	<!-- 아이디 찾기 -->
	<select id="selectFindId" parameterType="com.dahami.newsbank.web.dto.MemberDTO"
		resultType="com.dahami.newsbank.web.dto.MemberDTO">
		SELECT * FROM member
		WHERE name = #{name}
		AND phone= #{phone}
	</select>

	<!-- 활성 매체사 리스트 읽기 -->
	<select id="listAdjustMedia" resultType="com.dahami.newsbank.web.dto.MemberDTO">
		SELECT
		`seq`, `id`, `email`, `name`, `phone`, `type`,
		`permission`,
		`deferred`, `compNum`, `compDocPath`, `compName`,
		`compAddress`,
		`compAddDetail`, `compZipcode`, `compBankName`,
		`compBankAcc`,
		`compBankPath`, `compTel`, `compExtTel`, `contractPath`,
		DATE_FORMAT(`contractStart`,'%Y-%m-%d') AS `contractStart`,
		DATE_FORMAT(`contractEnd`,'%Y-%m-%d') AS `contractEnd`,
		`contractAuto`, `preRate`, `postRate`,
		`taxName`,
		`taxPhone`, `taxEmail`, `taxExtTell`, DATE_FORMAT(`regDate`,'%Y-%m-%d') AS
		`regDate`,
		`logo`, `activate`, `withdraw`, `group_seq` FROM `member`
		WHERE `type` IN ('M','F') 
		AND `activate` = 1
		AND `withdraw` = 0
		AND `compName`!=''
		AND `compName`
		is not null
		<if test="seq != 0">
			AND `seq` = #{seq}
			OR `seq` IN (SELECT `adjSlave` FROM
			`adjustment` A INNER JOIN `member` M ON A.adjSlave = M.seq WHERE M.`admission`='Y'
			AND `adjMaster` = #{seq})
		</if>
		ORDER BY `compName` ASC
	</select>
	
	<!-- 정산 매체사 리스트 읽기 -->
	<select id="adminAdjustMedia" resultType="com.dahami.newsbank.web.dto.MemberDTO">
		SELECT
		`seq`, `id`, `email`, `name`, `phone`, `type`,
		`permission`,
		`deferred`, `compNum`, `compDocPath`, `compName`,
		`compAddress`,
		`compAddDetail`, `compZipcode`, `compBankName`,
		`compBankAcc`,
		`compBankPath`, `compTel`, `compExtTel`, `contractPath`,
		DATE_FORMAT(`contractStart`,'%Y-%m-%d') AS `contractStart`,
		DATE_FORMAT(`contractEnd`,'%Y-%m-%d') AS `contractEnd`,
		`contractAuto`, `preRate`, `postRate`,
		`taxName`,
		`taxPhone`, `taxEmail`, `taxExtTell`, DATE_FORMAT(`regDate`,'%Y-%m-%d') AS
		`regDate`,
		`logo`, `activate`, `withdraw`, `group_seq` FROM `member`
		WHERE `type` IN ('M','F')
		<!-- AND `compName`!=''
		AND `compName` -->
		<if test="seq != 0">
			AND `seq` = #{seq}
			OR `seq` IN (SELECT `adjSlave` FROM
			`adjustment` A INNER JOIN `member` M ON A.adjMaster = M.seq WHERE M.`admission`='Y'
			AND `adjMaster` = #{seq})
		</if>
		ORDER BY `compName` ASC
	</select>
	
	<!-- 정산관리자 Slave 계정정보 전달 -->
	<select id="adjustMediaInfo" resultType="com.dahami.newsbank.web.dto.MemberDTO">
		SELECT
		`seq`, `id`, `email`, `name`, `phone`, `type`,
		`permission`,
		`deferred`, `compNum`, `compDocPath`, `compName`,
		`compAddress`,
		`compAddDetail`, `compZipcode`, `compBankName`,
		`compBankAcc`,
		`compBankPath`, `compTel`, `compExtTel`, `contractPath`,
		DATE_FORMAT(`contractStart`,'%Y-%m-%d') AS `contractStart`,
		DATE_FORMAT(`contractEnd`,'%Y-%m-%d') AS `contractEnd`,
		`contractAuto`, `preRate`, `postRate`,
		`taxName`,
		`taxPhone`, `taxEmail`, `taxExtTell`, DATE_FORMAT(`regDate`,'%Y-%m-%d') AS
		`regDate`,
		`logo`, `activate`, `withdraw`, `group_seq` FROM `member`
		WHERE `type` IN ('M','F')		
		<if test="seq != 0">
			AND `seq` = #{seq}
			OR `seq` IN (SELECT `adjSlave` FROM
			`adjustment` A INNER JOIN `member` M ON A.adjMaster = M.seq WHERE M.`admission`='Y'
			AND `adjMaster` = #{seq})
		</if>
		ORDER BY `compName` ASC
	</select>

	<!-- 주정산 매체에 따른 피정산 매체 목록 -->
	<select id="adjSlaveMedia" resultType="com.dahami.newsbank.web.dto.MemberDTO">
	    SELECT adjMaster, adjSlave, id, name, M.seq, email, phone, `type`, 
			`permission`,
			`deferred`, `compNum`, `compDocPath`, `compName`,
			`compAddress`,
			`compAddDetail`, `compZipcode`, `compBankName`,
			`compBankAcc`,
			`compBankPath`, `compTel`, `compExtTel`, `contractPath`, DATE_FORMAT(`contractStart`,'%Y-%m-%d') AS `contractStart`, DATE_FORMAT(`contractEnd`,'%Y-%m-%d') AS `contractEnd`,
			`contractAuto`, `preRate`, `postRate`,
			`taxName`,
			`taxPhone`, `taxEmail`, `taxExtTell`, DATE_FORMAT(M.`regDate`,'%Y-%m-%d') AS
			`regDate`,
			`logo`, `activate`, `withdraw`, `group_seq`
		FROM adjustment A
		INNER JOIN member M ON A.adjSlave = M.seq
		WHERE A.adjMaster = #{seq}
	</select>

	<select id="selGetty" resultType="com.dahami.newsbank.web.dto.MemberDTO">
		select * from member where id = BINARY('imazins');
	</select>
	
	<!-- 관리자 회원현황 목록 -->
	<select id="selMemberList" resultType="com.dahami.newsbank.web.dto.MemberDTO" parameterType="java.util.Map">
	    SELECT A.*, B.groupName FROM member A 
	    LEFT JOIN `group` B ON A.group_seq = B.seq
	    <where>
	        A.withdraw = 0 <!-- 정상 회원만 출력 -->
            <if test="keyword != null"> <!-- 키워드 -->
	            AND ( `id` LIKE CONCAT('%',#{keyword},'%') OR `name` LIKE CONCAT('%',#{keyword},'%') OR `compName` LIKE CONCAT('%',#{keyword},'%') )
            </if>
            	        
	        <if test="type != '' and type != null"> <!-- 회원구분 -->
	            AND `type` = #{type}
            </if>
            
			<if test="deferred != '' and deferred != null"> <!-- 결제구분 -->
				AND `deferred` = #{deferred}    
			</if>
			
			<if test='group == "I"'> <!-- 개별 -->
				AND `group_seq` is NULL    
			</if>
			
			<if test='group == "G"'> <!-- 그룹 -->
				AND `group_seq` is not NULL    
			</if>
			
		</where>
		ORDER BY A.regDate DESC 
		LIMIT #{startPage}, #{pageVol}
	</select>
	
	<!-- 정산 매체사 MediaDTO -->
	<resultMap id="MediaDTO" type="java.util.HashMap">
	    <!-- <result javaType="java.lang.Integer" column="blind" property="blind"></result>
	    <result javaType="java.lang.Integer" column="total" property="total"></result> -->
	    <result javaType="java.lang.Integer" column="seq" property="seq"></result>
	    <result javaType="java.lang.String" column="id" property="id"></result>
	    <result javaType="java.lang.String" column="email" property="email"></result>
	    <result javaType="java.lang.String" column="name" property="name"></result>
	    <result javaType="java.lang.String" column="phone" property="phone"></result>
	    <result javaType="java.lang.String" column="compNum" property="compNum"></result>
	    <result javaType="java.lang.String" column="compName" property="compName"></result>
	    <result javaType="java.lang.String" column="preRate" property="preRate"></result>
	    <result javaType="java.lang.String" column="postRate" property="postRate"></result>
	    <result javaType="java.lang.String" column="masterID" property="masterID"></result>
	    <result javaType="java.lang.String" column="logo" property="logo"></result>
	</resultMap>
	
	<!-- 관리자 정산 매체사 목록 -->	
	<select id="selMediaList" resultMap="MediaDTO" parameterType="java.util.Map">
	    SELECT (SELECT id FROM member WHERE seq = adjustment.adjMaster) AS masterID, member.seq, 
	    id, email, name, phone, compNum, compName, preRate, postRate, activate, logo 
	    FROM member 
		LEFT JOIN adjustment ON member.seq = adjustment.adjSlave
		WHERE member.type IN ('M','F') AND member.admission = 'Y' AND member.withdraw = 0
	        
        <if test="keyword != null"> 
         AND ( `id` LIKE CONCAT('%',#{keyword},'%') OR `name` LIKE CONCAT('%',#{keyword},'%') OR `compName` LIKE CONCAT('%',#{keyword},'%') )
        </if>
			
		ORDER BY member.regDate DESC 
		LIMIT #{startPage}, #{pageVol}
	</select>
	
	<!-- 콘텐츠 수량 DTO (블라인드 / 전체 갯수) -->
	<resultMap id="ContentDTO" type="java.util.HashMap">
	    <result javaType="java.lang.Integer" column="blind" property="blind"></result>
	    <result javaType="java.lang.Integer" column="total" property="total"></result>
    </resultMap>
    
	<!-- 블라인드 & 전체 콘텐츠 갯수 -->
	<select id="countContents" resultMap="ContentDTO" parameterType="java.util.Map">
		SELECT COALESCE(SUM(IF(saleStat=2, 1, 0)), 0) AS blindCnt, COUNT(uciCode) AS totalCnt
		FROM photo A
        LEFT JOIN member B ON A.member_seq = B.seq
		WHERE member_seq = #{seq} AND B.type IN ('M','F')
	</select>
	
	<!-- 회원현황(그룹추가) -->
	<insert id="insertGroup" useGeneratedKeys="true" keyProperty="seq">	    
	    <selectKey resultType="integer" keyProperty="seq" order="AFTER">
			SELECT
			LAST_INSERT_ID()
		</selectKey>
		INSERT INTO `group` (groupName, regDate) VALUES (#{groupName}, NOW())
	</insert>
	
	<!-- 회원현황 (선택회원 그룹정보 변경) -->
	<update id="updateMemberGroup">
	    UPDATE member SET group_seq = #{group_seq} WHERE 
	    <foreach collection="id" item="mID"  separator="OR">
	        ( id =BINARY(#{mID}) )
	    </foreach>
	</update>
	
	<!-- 조건에 따른 전체 회원명수 -->
	<select id="memberCnt" resultType="integer" parameterType="java.util.Map">
	    SELECT count(A.seq) FROM member A 
	    LEFT JOIN `group` B ON A.group_seq = B.seq
	    <where>
	        A.withdraw = 0 <!-- 정상 회원만 출력 -->
            <if test="keyword != null"> <!-- 키워드 -->
	            AND ( `id` LIKE CONCAT('%',#{keyword},'%') OR `name` LIKE CONCAT('%',#{keyword},'%') OR `compName` LIKE CONCAT('%',#{keyword},'%') )
            </if>
            	        
	        <if test="type != '' and type != null"> <!-- 회원구분 -->
	            AND `type` = #{type}
            </if>
            
			<if test="deferred != '' and deferred != null"> <!-- 결제구분 -->
				AND `deferred` = #{deferred}    
			</if>
			
			<if test='group == "I"'> <!-- 개별 -->
				AND `group_seq` is NULL    
			</if>
			
			<if test='group == "G"'> <!-- 그룹 -->
				AND `group_seq` is not NULL    
			</if>
			
		</where>
		ORDER BY A.regDate DESC
	</select>
	
	<!-- 조건에 따른 전체 정산매체수 -->
	<select id="mediaCnt" resultType="integer" parameterType="java.util.Map">	    
	    SELECT count(seq) as cnt 
	    FROM member 
	    WHERE `type` IN ('M','F') AND admission = 'Y' AND `withdraw` = 0
	        
        <if test="keyword != null and keyword != ''"> <!-- 키워드 -->
         AND ( `id` LIKE CONCAT('%',#{keyword},'%') OR `name` LIKE CONCAT('%',#{keyword},'%') OR `compName` LIKE CONCAT('%',#{keyword},'%') )
        </if>
            
	    ORDER BY regDate DESC
	</select>
	
	<!-- 회원탈퇴(withdraw 0: 정상, 1: 탈퇴) -->
	<update id="leaveMember" parameterType="com.dahami.newsbank.web.dto.MemberDTO">
	    UPDATE member SET withdraw = 1 WHERE seq = #{seq}
	</update>
	
	<select id="listOldMember" resultType="com.dahami.newsbank.web.dto.MemberDTO">
		<![CDATA[
		select * from member
			where loginDate < DATE_SUB(now(), interval 1 year)
				and oldMailSendDate is null
		]]>
	</select>
	
	<update id="setOldMailSend"  parameterType="int">
		update member set oldMailSendDate = now()
			where seq = #{value}
	</update>
	
	<select id="selMemExp" parameterType="string" resultType="int">
		SELECT seq FROM member WHERE id = #{value};
	</select>
	
	<select id="selName" parameterType="int" resultType="java.util.Map">
		SELECT name, phone
		FROM member
		WHERE `seq` = #{member_seq};
	</select>
</mapper>